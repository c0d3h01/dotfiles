#!/bin/sh

# Warn on staged additions that contain profanity or conflict markers.
SWEAR_WORDS='fuck|shit|crap|dammit|bitch|asshole'
CONFLICT_MARKERS='<<<<<<<|=======|>>>>>>>'

# Short-circuit if nothing staged to avoid expensive diffs.
git diff --cached --quiet --diff-filter=ACMRT && exit 0

COUNTS="$(
	git diff --cached --unified=0 --no-color --diff-filter=ACMRT |
		awk -v swear="$SWEAR_WORDS" -v conflict="$CONFLICT_MARKERS" '
      BEGIN { IGNORECASE = 1; s = 0; c = 0 }
      /^\+\+\+/ { next }
      /^\+/ {
        if ($0 ~ swear) s++
        if ($0 ~ conflict) c++
      }
      END { printf "%d %d\n", s, c }
    '
)"
SWEAR_COUNT="$(printf '%s' "$COUNTS" | awk '{print $1}')"
CONFLICT_COUNT="$(printf '%s' "$COUNTS" | awk '{print $2}')"

if [ "${SWEAR_COUNT:-0}" -gt 0 ]; then
	printf '\033[41m WARNING \033[0m %s potential swear word line(s) found\n' "$SWEAR_COUNT"
	git diff --cached --name-only -G"$SWEAR_WORDS" --diff-filter=ACMRT | sed 's/^/> /'
fi

if [ "${CONFLICT_COUNT:-0}" -gt 0 ]; then
	printf '\033[41m WARNING \033[0m %s conflict marker line(s) still present\n' "$CONFLICT_COUNT"
	git diff --cached --name-only -G"$CONFLICT_MARKERS" --diff-filter=ACMRT | sed 's/^/> /'
fi
