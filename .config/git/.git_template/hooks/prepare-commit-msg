#!/bin/sh

# Prepend the dominant staged top-level folder to the first line.
MSG_FILE="$1"
FIRST_LINE="$(sed -n '1p' "$MSG_FILE")"

case "$FIRST_LINE" in
  \[*\]\ *)
    exit 0
    ;;
  Merge\ *|Revert\ *|fixup!\ *|squash!\ *)
    exit 0
    ;;
esac

FOLDER="$(
  git diff --cached --name-only \
    | awk -F/ '
        NF == 1 { counts["root"]++; next }
        { counts[$1]++ }
        END {
          max = 0
          for (k in counts) {
            if (counts[k] > max) {
              max = counts[k]
              best = k
            }
          }
          if (best != "") {
            print best
          }
        }'
)"
[ -n "$FOLDER" ] || exit 0

TMP_FILE="${MSG_FILE}.tmp.$$"
{
  printf '[%s] %s\n' "$FOLDER" "$FIRST_LINE"
  sed -n '2,$p' "$MSG_FILE"
} > "$TMP_FILE"
mv "$TMP_FILE" "$MSG_FILE"
